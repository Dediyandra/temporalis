var __awaiter=this&&this.__awaiter||function(e,t,i,n){function r(e){return e instanceof i?e:new i((function(t){t(e)}))}return new(i||(i=Promise))((function(i,o){function a(e){try{c(n.next(e))}catch(t){o(t)}}function s(e){try{c(n["throw"](e))}catch(t){o(t)}}function c(e){e.done?i(e.value):r(e.value).then(a,s)}c((n=n.apply(e,t||[])).next())}))};var __generator=this&&this.__generator||function(e,t){var i={label:0,sent:function(){if(o[0]&1)throw o[1];return o[1]},trys:[],ops:[]},n,r,o,a;return a={next:s(0),throw:s(1),return:s(2)},typeof Symbol==="function"&&(a[Symbol.iterator]=function(){return this}),a;function s(e){return function(t){return c([e,t])}}function c(a){if(n)throw new TypeError("Generator is already executing.");while(i)try{if(n=1,r&&(o=a[0]&2?r["return"]:a[0]?r["throw"]||((o=r["return"])&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;if(r=0,o)a=[a[0]&2,o.value];switch(a[0]){case 0:case 1:o=a;break;case 4:i.label++;return{value:a[1],done:false};case 5:i.label++;r=a[1];a=[0];continue;case 7:a=i.ops.pop();i.trys.pop();continue;default:if(!(o=i.trys,o=o.length>0&&o[o.length-1])&&(a[0]===6||a[0]===2)){i=0;continue}if(a[0]===3&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(a[0]===6&&i.label<o[1]){i.label=o[1];o=a;break}if(o&&i.label<o[2]){i.label=o[2];i.ops.push(a);break}if(o[2])i.ops.pop();i.trys.pop();continue}a=t.call(e,i)}catch(s){a=[6,s];r=0}finally{n=o=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:true}}};System.register(["./p-193cfc60.system.js"],(function(e){"use strict";var t,i,n,r,o;return{setters:[function(e){t=e.r;i=e.h;n=e.H;r=e.g;o=e.c}],execute:function(){var a=window.MediaRecorder;var s=e("canvas_recorder",function(){function e(e){t(this,e)}e.prototype.render=function(){return i(n,null,i("slot",null))};e.prototype.componentDidLoad=function(){this.canvas=this.el.querySelector("canvas");if(a.isTypeSupported("video/webm;codecs=vp9")){this.options={mimeType:"video/webm; codecs=vp9"}}else if(a.isTypeSupported("video/webm;codecs=vp8")){this.options={mimeType:"video/webm; codecs=vp8"}}};e.prototype.isSupported=function(){return __awaiter(this,void 0,void 0,(function(){var e;return __generator(this,(function(t){e=document.createElement("canvas");return[2,e.captureStream!==undefined]}))}))};e.prototype.start=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(e){this.stream=this.canvas.captureStream(24);this.mediaRecorder=new a(this.stream,this.options);this.mediaRecorder.start();console.log(this.mediaRecorder);return[2]}))}))};e.prototype.status=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(e){return[2,this.mediaRecorder?this.mediaRecorder.state:"ready"]}))}))};e.prototype.stop=function(){return __awaiter(this,void 0,void 0,(function(){var e=this;return __generator(this,(function(t){return[2,new Promise((function(t,i){e.mediaRecorder.stop();e.mediaRecorder.ondataavailable=function(i){t(i.data);e.saveVideo(i.data)};e.mediaRecorder.onerror=i}))]}))}))};e.prototype.downloadURL=function(e,t){var i=document.createElement("a");document.body.appendChild(i);i.setAttribute("style","display: none");i.href=e;i.download=t;i.click();setTimeout((function(){return i.remove()}),2e3)};e.prototype.saveVideo=function(e){var t=URL.createObjectURL(e);this.downloadURL(t,this.getFileName()+".webm");setTimeout((function(){window.URL.revokeObjectURL(t)}),100)};e.prototype.saveImage=function(){return __awaiter(this,void 0,void 0,(function(){var e;return __generator(this,(function(t){e=this.canvas.toDataURL("image/png").replace("image/png","image/octet-stream");this.downloadURL(e,this.getFileName()+".png");return[2]}))}))};e.prototype.getFileName=function(){var e=(new Date).toString().split(" ");return"temporalis_"+e.slice(1,5).join("_")};Object.defineProperty(e.prototype,"el",{get:function(){return r(this)},enumerable:true,configurable:true});Object.defineProperty(e,"style",{get:function(){return":host{display:block}"},enumerable:true,configurable:true});return e}());var c=e("capture_button",function(){function e(e){t(this,e);this.isRecording=false;this.captureStart=0;this.isDown=false;this.snapshot=o(this,"snapshot",7);this.recordStart=o(this,"recordStart",7);this.recordEnd=o(this,"recordEnd",7)}e.prototype.onRecordingChanged=function(){this.isRecording?this.recordStart.emit():this.recordEnd.emit()};e.prototype.render=function(){return i(n,{onMouseUp:this.onMouseUp.bind(this),onMouseDown:this.onMouseDown.bind(this),onTouchStart:this.onMouseDown.bind(this),onTouchEnd:this.onMouseUp.bind(this),recording:this.isRecording},i("button",null),i("div",{class:"pulse"}))};e.prototype.onMouseDown=function(e){var t=this;e.preventDefault();console.log("onMouseDown");var i=Date.now();this.captureStart=i;this.isDown=true;setTimeout((function(){if(t.isDown){t.isRecording=true}}),250)};e.prototype.onMouseUp=function(e){e.preventDefault();if(!this.isDown)return;console.log("onMouseUp");this.isDown=false;if(this.isRecording){this.isRecording=false}else{this.snapshot.emit()}};Object.defineProperty(e,"watchers",{get:function(){return{isRecording:["onRecordingChanged"]}},enumerable:true,configurable:true});Object.defineProperty(e,"style",{get:function(){return"capture-button{width:80px;height:80px;-webkit-transition:-webkit-transform .3s ease-out;transition:-webkit-transform .3s ease-out;transition:transform .3s ease-out;transition:transform .3s ease-out,-webkit-transform .3s ease-out;z-index:1}capture-button button{background:none;cursor:pointer;border:none;outline:none;width:100%;height:100%}capture-button button:after,capture-button button:before{content:\"\";border-radius:50%;position:absolute}capture-button button:before{background:#333;width:80%;height:80%;top:10%;left:10%;-webkit-transition:background-color .3s ease-out;transition:background-color .3s ease-out}capture-button button:after{border:2px solid #fff;width:calc(100% - 4px);height:calc(100% - 4px);top:0;left:0}capture-button .pulse{opacity:0;pointer-events:none;position:absolute;top:0;left:0;-webkit-box-sizing:border-box;box-sizing:border-box;z-index:-1;border:3px solid red;width:100%;height:100%;border-radius:50%}capture-button[recording]{-webkit-transform:scale(.95);transform:scale(.95)}capture-button[recording] .pulse{-webkit-animation:pulseAnim 1s cubic-bezier(.165,.84,.44,1) both;animation:pulseAnim 1s cubic-bezier(.165,.84,.44,1) both}capture-button[recording] button:before{background:red}\@-webkit-keyframes pulseAnim{0%{-webkit-transform:scale(1);transform:scale(1);opacity:0}50%{opacity:1}to{opacity:0;-webkit-transform:scale(2);transform:scale(2)}}\@keyframes pulseAnim{0%{-webkit-transform:scale(1);transform:scale(1);opacity:0}50%{opacity:1}to{opacity:0;-webkit-transform:scale(2);transform:scale(2)}}"},enumerable:true,configurable:true});return e}());var u=navigator;navigator.getUserMedia=u.getUserMedia||u.webkitGetUserMedia||u.mozGetUserMedia||u.msGetUserMedia;var d=e("slit_scan",function(){function e(e){t(this,e);this.mode="vertical";this.cameraId=undefined;this.cameraFacingMode=undefined;this.slices=70;this.mirror=true;this.videoPreviousTime=-1;this.frames=[];this.onChangeMode()}e.prototype.onChangeMode=function(){this.drawMethod=this.mode==="horizontal"?this.drawHorz:this.drawVert};e.prototype.onChangeCameraId=function(){return __awaiter(this,void 0,void 0,(function(){var e,t,i;var n=this;return __generator(this,(function(r){switch(r.label){case 0:console.log("onChangeCameraId",this.cameraId);return[4,navigator.mediaDevices.enumerateDevices()];case 1:e=r.sent();t=e.filter((function(e){return e.kind==="videoinput"}));i=t.map((function(e){if(e.deviceId===n.cameraId){n.initCamera(e.deviceId);return e}return false})).filter((function(e){return e}));if(!i.length){this.initCamera(t[0].deviceId)}return[2]}}))}))};e.prototype.onChangeCameraFacingMode=function(e){this.initCamera(null,e)};e.prototype.componentDidLoad=function(){console.log("componentDidLoad");this.video=this.el.querySelector("video");this.canvas=this.el.querySelector("canvas#slit-scan");this.ctx=this.canvas.getContext("2d");this.bufferCanvas=this.el.querySelector("canvas#buffer");this.buffCtx=this.bufferCanvas.getContext("2d");this.ctx.imageSmoothingEnabled=false;this.video.addEventListener("loadedmetadata",this.onResize.bind(this));window.addEventListener("resize",this.onResize.bind(this));this.update()};e.prototype.render=function(){return i(n,null,i("video",{playsinline:true,muted:true,autoplay:true}),i("canvas",{id:"slit-scan"}),i("canvas",{id:"buffer"}))};e.prototype.onResize=function(){this.video.style.display="block";var e=1280/Math.max(this.video.videoWidth,this.video.videoHeight);var t=this.video.videoWidth*e;var i=this.video.videoHeight*e;this.canvas.width=t;this.canvas.height=i;this.bufferCanvas.width=t;this.bufferCanvas.height=i;this.video.style.display="none";var n=this.video.videoHeight/this.video.videoWidth;var r=window.innerHeight/window.innerWidth;var o=Math.max(n,r);var a=Math.abs((n-r)/o);this.canvas.style.objectFit=a<.15?"cover":"contain";console.log("fit",n,r,a,this.canvas.style.objectFit)};e.prototype.initCamera=function(e,t){var i=this;if(t===void 0){t=undefined}console.log("initCamera",e);var n={video:{deviceId:undefined,facingMode:undefined,width:{ideal:1280},height:{ideal:720},frameRate:{ideal:60}},audio:false};if(e)n.video.deviceId=e;else if(t)n.video.facingMode=t;console.log(n);if(this.stream){console.log("stopping old stream");this.video.pause();this.stream.getVideoTracks()[0].stop()}navigator.getUserMedia(n,(function(e){i.stream=e;console.log("localMediaStream",i.stream);console.log(i.stream.getVideoTracks()[0]);i.video.srcObject=i.stream;setTimeout((function(){i.video.play()}),500)}),(function(e){console.error(e)}))};e.prototype.update=function(){if(this.video.currentTime!==this.videoPreviousTime){this.draw()}this.videoPreviousTime=this.video.currentTime;requestAnimationFrame(this.update.bind(this))};e.prototype.drawVert=function(){var e=Math.ceil(this.canvas.height/this.slices);this.buffCtx.drawImage(this.video,0,0,this.video.videoWidth,this.video.videoHeight,0,0,this.bufferCanvas.width,this.bufferCanvas.height);this.frames.push(this.buffCtx.getImageData(0,0,this.bufferCanvas.width,this.bufferCanvas.height));var t=this.slices;while(t--){try{this.ctx.putImageData(this.frames[t],0,0,0,e*t,this.bufferCanvas.width,e)}catch(i){}}};e.prototype.drawHorz=function(){var e=Math.ceil(this.canvas.width/this.slices);this.buffCtx.drawImage(this.video,0,0,this.video.videoWidth,this.video.videoHeight,0,0,this.bufferCanvas.width,this.bufferCanvas.height);this.frames.push(this.buffCtx.getImageData(0,0,this.bufferCanvas.width,this.bufferCanvas.height));var t=this.slices;while(t--){try{this.ctx.putImageData(this.frames[t],0,0,e*t,0,e,this.bufferCanvas.height)}catch(i){}}};e.prototype.draw=function(){if(this.video.paused)return;this.drawMethod();while(this.frames.length>this.slices){this.frames.shift()}};Object.defineProperty(e.prototype,"el",{get:function(){return r(this)},enumerable:true,configurable:true});Object.defineProperty(e,"watchers",{get:function(){return{mode:["onChangeMode"],cameraId:["onChangeCameraId"],cameraFacingMode:["onChangeCameraFacingMode"]}},enumerable:true,configurable:true});Object.defineProperty(e,"style",{get:function(){return"slit-scan[mirror] #slit-scan{-webkit-transform:scaleX(-1);transform:scaleX(-1)}slit-scan #slit-scan{position:absolute;top:0;left:0;width:100%;height:100%;-o-object-fit:contain;object-fit:contain}slit-scan #buffer{position:absolute;top:0;left:0;z-index:1;display:none}"},enumerable:true,configurable:true});return e}());var h=typeof window.orientation!=="undefined"||navigator.userAgent.indexOf("IEMobile")!==-1;var l=window.document;var f=l.documentElement;var p=f.requestFullscreen||f.mozRequestFullScreen||f.webkitRequestFullScreen||f.msRequestFullscreen;var v=l.exitFullscreen||l.mozCancelFullScreen||l.webkitExitFullscreen||l.msExitFullscreen;var m=e("temporalis_app",function(){function e(e){t(this,e);this.recording=false;this.mirror=true;this.facingMode="user";this.mode=localStorage.getItem("mode");this.slices=parseInt(localStorage.getItem("slices"))||80;this.facingMode=localStorage.getItem("facingMode")}e.prototype.onMode=function(e){localStorage.setItem("mode",e)};e.prototype.onCameraId=function(e){localStorage.setItem("cameraId",e)};e.prototype.onSlices=function(e){localStorage.setItem("slices",e)};e.prototype.onFacingMode=function(e){localStorage.setItem("facingMode",e)};e.prototype.render=function(){return i(n,null,i("canvas-recorder",null,i("slit-scan",{mode:this.mode,cameraFacingMode:this.facingMode,slices:this.slices,cameraId:this.cameraId,mirror:this.mirror})),i("input",{id:"slices",type:"range",min:"20",max:"400",onInput:this.onChangeSlices.bind(this)}),i("button",{id:"switch-cam",title:"switch camera",onClick:this.onClickSwitchCam.bind(this)}),i("button",{id:"fullscreen",title:"fullscreen",onClick:this.onClickFullscreen.bind(this)}),i("button",{id:"mode",title:"change mode",onClick:this.onClickToggleMode.bind(this),"data-mode":this.mode}),i("capture-button",{title:"capture",onSnapshot:this.onClickSnapshot.bind(this),onRecordStart:this.onRecordStart.bind(this),onRecordEnd:this.onRecordEnd.bind(this)}))};e.prototype.componentDidLoad=function(){return __awaiter(this,void 0,void 0,(function(){var e,t;return __generator(this,(function(i){switch(i.label){case 0:this.recorder=this.el.querySelector("canvas-recorder");this.cameraId=localStorage.getItem("cameraId");if(!!this.cameraId)return[3,2];return[4,this.getCameras()];case 1:e=i.sent();this.cameraId=e[0].deviceId;i.label=2;case 2:t=this.el.querySelector("#slices");t.value=this.slices.toString();console.log(this.cameraId);return[2]}}))}))};e.prototype.getCameras=function(){return __awaiter(this,void 0,void 0,(function(){var e;return __generator(this,(function(t){switch(t.label){case 0:return[4,navigator.mediaDevices.enumerateDevices()];case 1:e=t.sent();return[2,e.filter((function(e){return e.kind==="videoinput"}))]}}))}))};e.prototype.onClickSnapshot=function(){this.recorder.saveImage()};e.prototype.onClickRecord=function(){this.recording?this.recorder.stop():this.recorder.start();this.recording=!this.recording};e.prototype.onRecordStart=function(){this.recording=true;this.recorder.start()};e.prototype.onRecordEnd=function(){this.recording=false;this.recorder.stop()};e.prototype.onChangeSlices=function(e){this.slices=e.target.value};e.prototype.onClickSwitchCam=function(){return __awaiter(this,void 0,void 0,(function(){var e,t,i,n,r;var o=this;return __generator(this,(function(a){switch(a.label){case 0:return[4,navigator.mediaDevices.enumerateDevices()];case 1:e=a.sent();t=e.filter((function(e){return e.kind==="videoinput"}));if(h){this.facingMode=this.facingMode==="user"?"environment":"user";this.mirror=this.facingMode==="user"}else{i=t.filter((function(e){return e.deviceId===o.cameraId}))[0];n=i?t.indexOf(i):0;r=(n+1)%t.length;this.cameraId=t[r].deviceId;console.log("onClickCamSwitch",n,r);this.mirror=true}return[2]}}))}))};e.prototype.onClickToggleMode=function(){this.mode==="vertical"?this.mode="horizontal":this.mode="vertical"};e.prototype.onClickFullscreen=function(){if(!l.fullscreenElement&&!l.mozFullScreenElement&&!l.webkitFullscreenElement&&!l.msFullscreenElement){p.call(f)}else{v.call(l)}};Object.defineProperty(e.prototype,"el",{get:function(){return r(this)},enumerable:true,configurable:true});Object.defineProperty(e,"watchers",{get:function(){return{mode:["onMode"],cameraId:["onCameraId"],slices:["onSlices"],facingMode:["onFacingMode"]}},enumerable:true,configurable:true});Object.defineProperty(e,"style",{get:function(){return"temporalis-app>button{outline:none;border:none;background:none;width:40px;height:40px;background:#fff;border-radius:50%;background-repeat:no-repeat;background-position:50%;position:absolute;right:35px;cursor:pointer}temporalis-app capture-button{position:absolute;bottom:15px;right:15px}temporalis-app #mode{bottom:105px;background-image:url(assets/menu-24px.svg);-webkit-transition:-webkit-transform .5s cubic-bezier(.19,1,.22,1);transition:-webkit-transform .5s cubic-bezier(.19,1,.22,1);transition:transform .5s cubic-bezier(.19,1,.22,1);transition:transform .5s cubic-bezier(.19,1,.22,1),-webkit-transform .5s cubic-bezier(.19,1,.22,1)}temporalis-app #mode[data-mode=horizontal]{-webkit-transform:rotate(90deg);transform:rotate(90deg)}temporalis-app #switch-cam{bottom:155px;background-image:url(assets/flip_camera_ios-24px.svg)}temporalis-app #fullscreen{top:15px;background-image:url(assets/fullscreen-24px.svg)}temporalis-app #slices{position:absolute;bottom:25px;right:105px;width:calc(100% - 105px - 30px);max-width:300px}temporalis-app input[type=range]{-webkit-appearance:none;width:100%;height:20px;background:transparent}temporalis-app input[type=range]:focus{outline:none}temporalis-app input[type=range]::-ms-track{width:100%;cursor:pointer;background:transparent;border-color:transparent;color:transparent}temporalis-app input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;border:1px solid #fff;height:20px;width:20px;border-radius:50%;background:#333;cursor:pointer;margin-top:-9px}temporalis-app input[type=range]::-moz-range-thumb{-webkit-appearance:none;border:1px solid #fff;height:20px;width:20px;border-radius:50%;background:#333;cursor:pointer}temporalis-app input[type=range]::-ms-thumb{-webkit-appearance:none;border:1px solid #fff;height:20px;width:20px;border-radius:50%;background:#333;cursor:pointer}temporalis-app input[type=range]::-webkit-slider-runnable-track{width:100%;height:1px;cursor:pointer;background:#fff;border-radius:50%}temporalis-app input[type=range]:focus::-webkit-slider-runnable-track{background:#fff}temporalis-app input[type=range]::-moz-range-track{width:100%;height:1px;cursor:pointer;background:#fff;border-radius:50%}"},enumerable:true,configurable:true});return e}())}}}));