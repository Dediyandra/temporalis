import{r as t,h as s,H as i,g as e,c as o}from"./p-c6d33a18.js";const{MediaRecorder:h}=window,a=class{constructor(s){t(this,s)}render(){return s(i,null,s("slot",null))}componentDidLoad(){this.canvas=this.el.querySelector("canvas"),h.isTypeSupported("video/webm;codecs=vp9")?this.options={mimeType:"video/webm; codecs=vp9"}:h.isTypeSupported("video/webm;codecs=vp8")&&(this.options={mimeType:"video/webm; codecs=vp8"})}async isSupported(){return void 0!==document.createElement("canvas").captureStream}async start(){this.stream=this.canvas.captureStream(24),this.mediaRecorder=new h(this.stream,this.options),this.mediaRecorder.start(),console.log(this.mediaRecorder)}async status(){return this.mediaRecorder?this.mediaRecorder.state:"ready"}async stop(){return new Promise((t,s)=>{this.mediaRecorder.stop(),this.mediaRecorder.ondataavailable=s=>{t(s.data),this.saveVideo(s.data)},this.mediaRecorder.onerror=s})}downloadURL(t,s){const i=document.createElement("a");document.body.appendChild(i),i.setAttribute("style","display: none"),i.href=t,i.download=s,i.click(),setTimeout(()=>i.remove(),2e3)}saveVideo(t){const s=URL.createObjectURL(t);this.downloadURL(s,this.getFileName()+".webm"),setTimeout(()=>{window.URL.revokeObjectURL(s)},100)}async saveImage(){var t=this.canvas.toDataURL("image/png").replace("image/png","image/octet-stream");this.downloadURL(t,this.getFileName()+".png")}getFileName(){return"temporalis_"+(new Date).toString().split(" ").slice(1,5).join("_")}get el(){return e(this)}static get style(){return":host{display:block}"}},n=class{constructor(s){t(this,s),this.isRecording=!1,this.captureStart=0,this.isDown=!1,this.snapshot=o(this,"snapshot",7),this.recordStart=o(this,"recordStart",7),this.recordEnd=o(this,"recordEnd",7)}onRecordingChanged(){this.isRecording?this.recordStart.emit():this.recordEnd.emit()}render(){return s(i,{onMouseUp:this.onMouseUp.bind(this),onMouseDown:this.onMouseDown.bind(this),onTouchStart:this.onMouseDown.bind(this),onTouchEnd:this.onMouseUp.bind(this),recording:this.isRecording},s("button",null),s("div",{class:"pulse"}))}onMouseDown(t){t.preventDefault(),console.log("onMouseDown");const s=Date.now();this.captureStart=s,this.isDown=!0,setTimeout(()=>{this.isDown&&(this.isRecording=!0)},250)}onMouseUp(t){t.preventDefault(),this.isDown&&(console.log("onMouseUp"),this.isDown=!1,this.isRecording?this.isRecording=!1:this.snapshot.emit())}static get watchers(){return{isRecording:["onRecordingChanged"]}}static get style(){return"capture-button{width:80px;height:80px;-webkit-transition:-webkit-transform .3s ease-out;transition:-webkit-transform .3s ease-out;transition:transform .3s ease-out;transition:transform .3s ease-out,-webkit-transform .3s ease-out;z-index:1}capture-button button{background:none;cursor:pointer;border:none;outline:none;width:100%;height:100%}capture-button button:after,capture-button button:before{content:\"\";border-radius:50%;position:absolute}capture-button button:before{background:#333;width:80%;height:80%;top:10%;left:10%;-webkit-transition:background-color .3s ease-out;transition:background-color .3s ease-out}capture-button button:after{border:2px solid #fff;width:calc(100% - 4px);height:calc(100% - 4px);top:0;left:0}capture-button .pulse{opacity:0;pointer-events:none;position:absolute;top:0;left:0;-webkit-box-sizing:border-box;box-sizing:border-box;z-index:-1;border:3px solid red;width:100%;height:100%;border-radius:50%}capture-button[recording]{-webkit-transform:scale(.95);transform:scale(.95)}capture-button[recording] .pulse{-webkit-animation:pulseAnim 1s cubic-bezier(.165,.84,.44,1) both;animation:pulseAnim 1s cubic-bezier(.165,.84,.44,1) both}capture-button[recording] button:before{background:red}\@-webkit-keyframes pulseAnim{0%{-webkit-transform:scale(1);transform:scale(1);opacity:0}50%{opacity:1}to{opacity:0;-webkit-transform:scale(2);transform:scale(2)}}\@keyframes pulseAnim{0%{-webkit-transform:scale(1);transform:scale(1);opacity:0}50%{opacity:1}to{opacity:0;-webkit-transform:scale(2);transform:scale(2)}}"}},r=navigator;navigator.getUserMedia=r.getUserMedia||r.webkitGetUserMedia||r.mozGetUserMedia||r.msGetUserMedia;const c=class{constructor(s){t(this,s),this.mode="vertical",this.cameraId=void 0,this.cameraFacingMode=void 0,this.slices=70,this.mirror=!0,this.videoPreviousTime=-1,this.frames=[],this.onChangeMode()}onChangeMode(){this.drawMethod="horizontal"===this.mode?this.drawHorz:this.drawVert}async onChangeCameraId(){console.log("onChangeCameraId",this.cameraId);const t=(await navigator.mediaDevices.enumerateDevices()).filter(t=>"videoinput"===t.kind);t.map(t=>t.deviceId===this.cameraId&&(this.initCamera(t.deviceId),t)).filter(t=>t).length||this.initCamera(t[0].deviceId)}onChangeCameraFacingMode(t){this.initCamera(null,t)}componentDidLoad(){console.log("componentDidLoad"),this.video=this.el.querySelector("video"),this.canvas=this.el.querySelector("canvas#slit-scan"),this.ctx=this.canvas.getContext("2d"),this.bufferCanvas=this.el.querySelector("canvas#buffer"),this.buffCtx=this.bufferCanvas.getContext("2d"),this.ctx.imageSmoothingEnabled=!1,this.video.addEventListener("loadedmetadata",this.onResize.bind(this)),window.addEventListener("resize",this.onResize.bind(this)),this.update()}render(){return s(i,null,s("video",{playsinline:!0,muted:!0,autoplay:!0}),s("canvas",{id:"slit-scan"}),s("canvas",{id:"buffer"}))}onResize(){this.video.style.display="block";var t=1280/Math.max(this.video.videoWidth,this.video.videoHeight),s=this.video.videoWidth*t,i=this.video.videoHeight*t;this.canvas.width=s,this.canvas.height=i,this.bufferCanvas.width=s,this.bufferCanvas.height=i,this.video.style.display="none";const e=this.video.videoHeight/this.video.videoWidth,o=window.innerHeight/window.innerWidth,h=Math.max(e,o),a=Math.abs((e-o)/h);this.canvas.style.objectFit=a<.15?"cover":"contain",console.log("fit",e,o,a,this.canvas.style.objectFit)}initCamera(t,s){console.log("initCamera",t);var i={video:{deviceId:void 0,facingMode:void 0,width:{ideal:1280},height:{ideal:720},frameRate:{ideal:60}},audio:!1};t?i.video.deviceId=t:s&&(i.video.facingMode=s),console.log(i),this.stream&&(console.log("stopping old stream"),this.video.pause(),this.stream.getVideoTracks()[0].stop()),navigator.getUserMedia(i,t=>{this.stream=t,console.log("localMediaStream",this.stream),console.log(this.stream.getVideoTracks()[0]),this.video.srcObject=this.stream,setTimeout(()=>{this.video.play()},500)},t=>{console.error(t)})}update(){this.video.currentTime!==this.videoPreviousTime&&this.draw(),this.videoPreviousTime=this.video.currentTime,requestAnimationFrame(this.update.bind(this))}drawVert(){var t=Math.ceil(this.canvas.height/this.slices);this.buffCtx.drawImage(this.video,0,0,this.video.videoWidth,this.video.videoHeight,0,0,this.bufferCanvas.width,this.bufferCanvas.height),this.frames.push(this.buffCtx.getImageData(0,0,this.bufferCanvas.width,this.bufferCanvas.height));for(var s=this.slices;s--;)try{this.ctx.putImageData(this.frames[s],0,0,0,t*s,this.bufferCanvas.width,t)}catch(i){}}drawHorz(){var t=Math.ceil(this.canvas.width/this.slices);this.buffCtx.drawImage(this.video,0,0,this.video.videoWidth,this.video.videoHeight,0,0,this.bufferCanvas.width,this.bufferCanvas.height),this.frames.push(this.buffCtx.getImageData(0,0,this.bufferCanvas.width,this.bufferCanvas.height));for(var s=this.slices;s--;)try{this.ctx.putImageData(this.frames[s],0,0,t*s,0,t,this.bufferCanvas.height)}catch(i){}}draw(){if(!this.video.paused)for(this.drawMethod();this.frames.length>this.slices;)this.frames.shift()}get el(){return e(this)}static get watchers(){return{mode:["onChangeMode"],cameraId:["onChangeCameraId"],cameraFacingMode:["onChangeCameraFacingMode"]}}static get style(){return"slit-scan[mirror] #slit-scan{-webkit-transform:scaleX(-1);transform:scaleX(-1)}slit-scan #slit-scan{position:absolute;top:0;left:0;width:100%;height:100%;-o-object-fit:contain;object-fit:contain}slit-scan #buffer{position:absolute;top:0;left:0;z-index:1;display:none}"}},d=void 0!==window.orientation||-1!==navigator.userAgent.indexOf("IEMobile"),l=window.document,u=l.documentElement,m=u.requestFullscreen||u.mozRequestFullScreen||u.webkitRequestFullScreen||u.msRequestFullscreen,g=l.exitFullscreen||l.mozCancelFullScreen||l.webkitExitFullscreen||l.msExitFullscreen,v=class{constructor(s){t(this,s),this.recording=!1,this.mirror=!0,this.facingMode="user",this.mode=localStorage.getItem("mode"),this.slices=parseInt(localStorage.getItem("slices"))||80,this.facingMode=localStorage.getItem("facingMode")}onMode(t){localStorage.setItem("mode",t)}onCameraId(t){localStorage.setItem("cameraId",t)}onSlices(t){localStorage.setItem("slices",t)}onFacingMode(t){localStorage.setItem("facingMode",t)}render(){return s(i,null,s("canvas-recorder",null,s("slit-scan",{mode:this.mode,cameraFacingMode:this.facingMode,slices:this.slices,cameraId:this.cameraId,mirror:this.mirror})),s("input",{id:"slices",type:"range",min:"20",max:"400",onInput:this.onChangeSlices.bind(this)}),s("button",{id:"switch-cam",title:"switch camera",onClick:this.onClickSwitchCam.bind(this)}),s("button",{id:"fullscreen",title:"fullscreen",onClick:this.onClickFullscreen.bind(this)}),s("button",{id:"mode",title:"change mode",onClick:this.onClickToggleMode.bind(this),"data-mode":this.mode}),s("capture-button",{title:"capture",onSnapshot:this.onClickSnapshot.bind(this),onRecordStart:this.onRecordStart.bind(this),onRecordEnd:this.onRecordEnd.bind(this)}))}async componentDidLoad(){if(this.recorder=this.el.querySelector("canvas-recorder"),this.cameraId=localStorage.getItem("cameraId"),!this.cameraId){const t=await this.getCameras();this.cameraId=t[0].deviceId}this.el.querySelector("#slices").value=this.slices.toString(),console.log(this.cameraId)}async getCameras(){return(await navigator.mediaDevices.enumerateDevices()).filter(t=>"videoinput"===t.kind)}onClickSnapshot(){this.recorder.saveImage()}onClickRecord(){this.recording?this.recorder.stop():this.recorder.start(),this.recording=!this.recording}onRecordStart(){this.recording=!0,this.recorder.start()}onRecordEnd(){this.recording=!1,this.recorder.stop()}onChangeSlices(t){this.slices=t.target.value}async onClickSwitchCam(){const t=(await navigator.mediaDevices.enumerateDevices()).filter(t=>"videoinput"===t.kind);if(d)this.facingMode="user"===this.facingMode?"environment":"user",this.mirror="user"===this.facingMode;else{const s=t.filter(t=>t.deviceId===this.cameraId)[0],i=s?t.indexOf(s):0,e=(i+1)%t.length;this.cameraId=t[e].deviceId,console.log("onClickCamSwitch",i,e),this.mirror=!0}}onClickToggleMode(){this.mode="vertical"===this.mode?"horizontal":"vertical"}onClickFullscreen(){l.fullscreenElement||l.mozFullScreenElement||l.webkitFullscreenElement||l.msFullscreenElement?g.call(l):m.call(u)}get el(){return e(this)}static get watchers(){return{mode:["onMode"],cameraId:["onCameraId"],slices:["onSlices"],facingMode:["onFacingMode"]}}static get style(){return"temporalis-app>button{outline:none;border:none;background:none;width:40px;height:40px;background:#fff;border-radius:50%;background-repeat:no-repeat;background-position:50%;position:absolute;right:35px;cursor:pointer}temporalis-app capture-button{position:absolute;bottom:15px;right:15px}temporalis-app #mode{bottom:105px;background-image:url(assets/menu-24px.svg);-webkit-transition:-webkit-transform .5s cubic-bezier(.19,1,.22,1);transition:-webkit-transform .5s cubic-bezier(.19,1,.22,1);transition:transform .5s cubic-bezier(.19,1,.22,1);transition:transform .5s cubic-bezier(.19,1,.22,1),-webkit-transform .5s cubic-bezier(.19,1,.22,1)}temporalis-app #mode[data-mode=horizontal]{-webkit-transform:rotate(90deg);transform:rotate(90deg)}temporalis-app #switch-cam{bottom:155px;background-image:url(assets/flip_camera_ios-24px.svg)}temporalis-app #fullscreen{top:15px;background-image:url(assets/fullscreen-24px.svg)}temporalis-app #slices{position:absolute;bottom:25px;right:105px;width:calc(100% - 105px - 30px);max-width:300px}temporalis-app input[type=range]{-webkit-appearance:none;width:100%;height:20px;background:transparent}temporalis-app input[type=range]:focus{outline:none}temporalis-app input[type=range]::-ms-track{width:100%;cursor:pointer;background:transparent;border-color:transparent;color:transparent}temporalis-app input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;border:1px solid #fff;height:20px;width:20px;border-radius:50%;background:#333;cursor:pointer;margin-top:-9px}temporalis-app input[type=range]::-moz-range-thumb{-webkit-appearance:none;border:1px solid #fff;height:20px;width:20px;border-radius:50%;background:#333;cursor:pointer}temporalis-app input[type=range]::-ms-thumb{-webkit-appearance:none;border:1px solid #fff;height:20px;width:20px;border-radius:50%;background:#333;cursor:pointer}temporalis-app input[type=range]::-webkit-slider-runnable-track{width:100%;height:1px;cursor:pointer;background:#fff;border-radius:50%}temporalis-app input[type=range]:focus::-webkit-slider-runnable-track{background:#fff}temporalis-app input[type=range]::-moz-range-track{width:100%;height:1px;cursor:pointer;background:#fff;border-radius:50%}"}};export{a as canvas_recorder,n as capture_button,c as slit_scan,v as temporalis_app};